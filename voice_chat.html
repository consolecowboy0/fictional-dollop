<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iRacing Voice Coach</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            max-width: 600px;
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        
        .telemetry {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .telemetry-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .telemetry-row:last-child {
            border-bottom: none;
        }
        
        .label {
            opacity: 0.7;
        }
        
        .value {
            font-weight: bold;
            font-size: 1.2em;
        }
        
        .controls {
            text-align: center;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 10px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .status {
            text-align: center;
            margin-top: 20px;
            font-size: 1.1em;
            opacity: 0.8;
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .error {
            background: rgba(255, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            border: 1px solid rgba(255, 0, 0, 0.5);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèéÔ∏è iRacing Voice Coach</h1>
        
        <div class="telemetry">
            <div class="telemetry-row">
                <span class="label">Track:</span>
                <span class="value" id="track">--</span>
            </div>
            <div class="telemetry-row">
                <span class="label">Speed:</span>
                <span class="value" id="speed">-- mph</span>
            </div>
            <div class="telemetry-row">
                <span class="label">RPM:</span>
                <span class="value" id="rpm">--</span>
            </div>
            <div class="telemetry-row">
                <span class="label">Gear:</span>
                <span class="value" id="gear">--</span>
            </div>
            <div class="telemetry-row">
                <span class="label">Position:</span>
                <span class="value" id="position">--</span>
            </div>
            <div class="telemetry-row">
                <span class="label">Lap:</span>
                <span class="value" id="lap">--</span>
            </div>
        </div>
        
        <div class="controls">
            <button id="connectBtn" onclick="connect()">Connect Voice Chat</button>
            <button id="disconnectBtn" onclick="disconnect()" style="display: none;">Disconnect</button>
        </div>
        
        <div class="status" id="status">Ready to connect</div>
        <div id="error" style="display: none;"></div>
    </div>

    <script>
        let pc = null;
        let dataChannel = null;
        let audioElement = null;
        let telemetryInterval = null;
        let lastTelemetry = null;
        
        // Send telemetry context to AI
        function sendTelemetryContext() {
            if (!dataChannel || dataChannel.readyState !== 'open' || !lastTelemetry) {
                return;
            }
            
            try {
                const data = lastTelemetry;
                const contextMessage = {
                    type: 'conversation.item.create',
                    item: {
                        type: 'message',
                        role: 'system',
                        content: [{
                            type: 'input_text',
                            text: `Current telemetry: Track="${data.track.name}", Position=${data.situation.position}, Lap=${data.situation.lap}, Speed=${data.telemetry.speed_mph.toFixed(1)}mph, RPM=${data.telemetry.rpm}, Gear=${data.telemetry.gear}`
                        }]
                    }
                };
                dataChannel.send(JSON.stringify(contextMessage));
                console.log('Sent telemetry context to AI');
            } catch (err) {
                console.error('Failed to send telemetry context:', err);
            }
        }
        
        // Update telemetry display
        async function updateTelemetry() {
            try {
                const response = await fetch('http://localhost:5000/api/telemetry');
                const data = await response.json();
                
                lastTelemetry = data;
                
                document.getElementById('track').textContent = data.track.name || 'Unknown';
                document.getElementById('speed').textContent = `${(data.telemetry.speed_mph || 0).toFixed(1)} mph`;
                document.getElementById('rpm').textContent = data.telemetry.rpm || 0;
                document.getElementById('gear').textContent = data.telemetry.gear || 0;
                document.getElementById('position').textContent = data.situation.position || 'Unknown';
                document.getElementById('lap').textContent = data.situation.lap || 'Unknown';
                
                // Send telemetry update to AI every 5 seconds (not every second to avoid spam)
                if (dataChannel && dataChannel.readyState === 'open') {
                    const now = Date.now();
                    if (!updateTelemetry.lastSent || now - updateTelemetry.lastSent > 5000) {
                        sendTelemetryContext();
                        updateTelemetry.lastSent = now;
                    }
                }
            } catch (err) {
                console.error('Failed to update telemetry:', err);
            }
        }
        
        // Connect to voice chat
        async function connect() {
            try {
                setStatus('Connecting...', true);
                document.getElementById('connectBtn').disabled = true;
                
                // Get session from server
                const sessionResponse = await fetch('http://localhost:5000/api/session');
                if (!sessionResponse.ok) {
                    throw new Error('Failed to create session');
                }
                const sessionData = await sessionResponse.json();
                
                if (sessionData.error) {
                    throw new Error(sessionData.error);
                }
                
                console.log('Session data:', sessionData);
                
                // Create WebRTC connection  
                const ephemeralKey = sessionData.client_secret.client_secret?.value || sessionData.client_secret;
                
                pc = new RTCPeerConnection();
                
                // Add audio element for playback
                audioElement = document.createElement('audio');
                audioElement.autoplay = true;
                pc.ontrack = e => {
                    console.log('Received track:', e);
                    audioElement.srcObject = e.streams[0];
                };
                
                // Add microphone
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                pc.addTrack(stream.getTracks()[0]);
                
                // Create data channel for events
                dataChannel = pc.createDataChannel('oai-events');
                dataChannel.addEventListener('message', (e) => {
                    const event = JSON.parse(e.data);
                    console.log('OpenAI Event:', event);
                });
                
                dataChannel.addEventListener('open', () => {
                    console.log('Data channel opened');
                    // Send initial context when channel opens
                    sendTelemetryContext();
                });
                
                // Create and set local offer
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                
                console.log('Sending offer to OpenAI...');
                
                // Send offer to OpenAI Realtime API
                const sdpResponse = await fetch('https://api.openai.com/v1/realtime', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${ephemeralKey}`,
                        'Content-Type': 'application/sdp'
                    },
                    body: offer.sdp
                });
                
                if (!sdpResponse.ok) {
                    const errorText = await sdpResponse.text();
                    console.error('OpenAI SDP error:', errorText);
                    throw new Error(`Failed to connect to OpenAI: ${sdpResponse.status} - ${errorText}`);
                }
                
                const answer = await sdpResponse.text();
                console.log('Received answer from OpenAI');
                
                await pc.setRemoteDescription({ type: 'answer', sdp: answer });
                
                // Start telemetry updates
                telemetryInterval = setInterval(updateTelemetry, 1000);
                updateTelemetry();
                
                // Update UI
                document.getElementById('connectBtn').style.display = 'none';
                document.getElementById('disconnectBtn').style.display = 'inline-block';
                setStatus('Connected - Speak to your coach!', false);
                
            } catch (err) {
                console.error('Connection error:', err);
                showError(err.message);
                setStatus('Connection failed', false);
                document.getElementById('connectBtn').disabled = false;
            }
        }
        
        // Disconnect
        function disconnect() {
            if (pc) {
                pc.close();
                pc = null;
            }
            if (dataChannel) {
                dataChannel.close();
                dataChannel = null;
            }
            if (audioElement) {
                audioElement.srcObject = null;
                audioElement = null;
            }
            if (telemetryInterval) {
                clearInterval(telemetryInterval);
                telemetryInterval = null;
            }
            
            document.getElementById('connectBtn').style.display = 'inline-block';
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('disconnectBtn').style.display = 'none';
            setStatus('Disconnected', false);
        }
        
        function setStatus(message, pulse) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            if (pulse) {
                statusEl.classList.add('pulse');
            } else {
                statusEl.classList.remove('pulse');
            }
        }
        
        function showError(message) {
            const errorEl = document.getElementById('error');
            errorEl.innerHTML = `<div class="error">Error: ${message}</div>`;
            errorEl.style.display = 'block';
            setTimeout(() => {
                errorEl.style.display = 'none';
            }, 5000);
        }
        
        // Initial telemetry load
        updateTelemetry();
    </script>
</body>
</html>
